<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CV Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<script>
function cerrarApp() {
    const overlay = document.getElementById("overlay");
    const overlayText = document.getElementById("overlayText");
    const spinner = document.getElementById("overlaySpinner");

    // Mostrar overlay
    overlay.classList.add("active");

    // Cambiar mensaje
    overlayText.textContent = "Aplicaci√≥n cerrada";

    // Ocultar spinner
    spinner.style.display = "none";

    // Esperar 1 segundo y cerrar backend
    setTimeout(() => {
        navigator.sendBeacon("/shutdown");
    }, 1000);
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("cvForm");
    const overlay = document.getElementById("overlay");
    const resultBox = document.getElementById("resultBox");
    const submitBtn = document.getElementById("submitBtn");
    const fileInput = form.querySelector('input[type="file"]');

    const reuseBtn = document.getElementById("reuseBtn");
    const reuseInput = document.getElementById("reuse_last");
    
    let reuseActive = false;

    if (reuseBtn) {
        reuseBtn.addEventListener("click", () => {
            reuseActive = !reuseActive;

            if (reuseActive) {
                fileInput.disabled = true;
                fileInput.removeAttribute("required");
                reuseInput.value = "1";

                reuseBtn.textContent = "‚úî Usando √∫ltimo CV";
                reuseBtn.classList.add("active");
            } else {
                fileInput.disabled = false;
                fileInput.setAttribute("required", "required");
                reuseInput.value = "0";

                reuseBtn.textContent = "üîÅ Usar √∫ltimo CV";
                reuseBtn.classList.remove("active");
            }
        });
    }

    form.addEventListener("submit", () => {
        // Mostrar overlay
        overlay.classList.add("active");

        // Desactivar el bot√≥n
        submitBtn.disabled = true;

        // Ocultar resultados anteriores
        if (resultBox) {
            resultBox.style.display = "none";
        }

        setTimeout(() => {
            [...form.elements].forEach(el => {
                if (el !== fileInput) {
                    el.disabled = true;
                }
            });
        }, 0);
    });

    // Si cambia el archivo pues limpiar resultados
    fileInput.addEventListener("change", () => {
        if (resultBox) {
            resultBox.style.display = "none";
        }
    });
});
</script>

<div class="card">
    <button type="button" class="close-btn" onclick="cerrarApp()" title="Cerrar aplicaci√≥n">
        ‚úñ
    </button>

    <form method="POST" enctype="multipart/form-data" id="cvForm">
        <label>CV en PDF</label>
        <input type="file" name="cv_pdf" required>
        {% if last_cv_exists %}
            <button type="button" id="reuseBtn" class="reuse-btn">
                üîÅ Usar √∫ltimo CV
            </button>
        {% endif %}

        <input type="hidden" name="reuse_last" id="reuse_last" value="0">

        <label>Plantilla</label>
        <select name="plantilla" required>
            <option value="1">Plantilla-DTA</option>
            <option value="2">Plantilla-EUROPASS</option>
            <option value="3">Plantilla-IBM</option>
            <!--<option value="4">Plantilla-NNT</option>
            <option value="5">Plantilla-NNTS</option>-->
            <option value="6">Plantilla-INETUM</option>
           <!-- <option value="7">Plantilla-RICOH</option>-->
            <option value="8">Plantilla-SAPIENS</option>
            <!-- <option value="9">Plantilla-ACCENTURE</option>-->
            <option value="10">Plantilla-Testeo</option>
            <option value="11">Plantilla-Basica</option> 
        </select>

        <button type="submit" id="submitBtn">
            <span class="btn-text">Generar CV</span>
            <span class="spinner"></span>
        </button>
    </form>

    {% if success %}
    <div class="success" id="resultBox">
        <div class="result-name">
            CV generado de <strong>{{ nombre }}</strong>
        </div>

        <a href="/download/{{ docx }}">üìò Descargar DOCX</a><br>

        {% if pdf %}
            <a href="/download/{{ pdf }}">üìï Descargar PDF</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<div id="overlay">
    <div class="overlay-content">
        <span class="spinner" id="overlaySpinner"></span>
        <p id="overlayText">Procesando CV...</p>
    </div>
</div>
